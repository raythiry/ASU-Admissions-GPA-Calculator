<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ASU Admissions GPA Calculator â€” ASU</title>
  <style>
    :root{
      --maroon:#8C1D40; /* ASU Maroon */
      --gold:#FFC627;   /* ASU Gold */
      --ok:#10B981;     /* green-500 */
      --warn:#F59E0B;   /* amber-500 */
      --bad:#EF4444;    /* red-500 */

      --card:#ffffff;   /* light card */
      --card-border:#E5E7EB; /* light border */
      --bg:#ffffff;     /* page bg */
      --text:#111827;   /* gray-900 */
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; color:var(--text); background:var(--bg); }
    a{color:var(--maroon); text-decoration:underline}

    .wrap{max-width:980px; margin:40px auto; padding:0 16px}
    header{background:linear-gradient(90deg,var(--maroon),#5e0f2a); border:1px solid rgba(0,0,0,.06); color:white; padding:18px 20px; border-radius:16px; box-shadow:0 10px 24px rgba(140,29,64,.15); display:flex; align-items:center; justify-content:space-between; gap:12px}
    header h1{margin:0; font-size:clamp(22px,3.2vw,32px); letter-spacing:.2px}
    header p{margin:8px 0 0; color:#fff; opacity:.92}
    .ver{display:inline-flex; align-items:center; gap:8px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; font-size:13px; font-weight:700}
    .pill.ok{background:linear-gradient(90deg, rgba(16,185,129,.18), rgba(16,185,129,.06)); color:#065F46}
    .pill.warn{background:linear-gradient(90deg, rgba(245,158,11,.18), rgba(245,158,11,.06)); color:#92400E}
    .pill.bad{background:linear-gradient(90deg, rgba(239,68,68,.18), rgba(239,68,68,.06)); color:#991B1B}

    .grid{display:grid; gap:16px}
    @media (min-width:900px){.grid-2{grid-template-columns: 1.2fr .8fr}}

    .card{background:var(--card); border:1px solid var(--card-border); border-radius:16px; box-shadow:0 8px 22px rgba(0,0,0,.06)}
    .card h2{margin:0 0 8px; font-size:20px; color:var(--text)}
    .card .hd{display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--card-border)}
    .card .bd{padding:18px}

    /* Colorful blocks */
    .qblock{border:1px solid var(--card-border); background:linear-gradient(180deg, #fff, #f9fafb); padding:12px; border-radius:14px; margin-bottom:12px; position:relative; overflow:hidden}
    .qblock h3{margin:0 0 8px; color:var(--maroon); font-size:16px}
    .subhead{margin:10px 0 6px; color:var(--text); font-weight:700; font-size:14px}

    label{display:block; font-size:14px; color:var(--text); margin:8px 0 6px}
    select, input[type=number]{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--card-border); background:#fff; color:var(--text); outline:none; }
    select:focus, input[type=number]:focus{border-color:var(--gold); box-shadow:0 0 0 3px rgba(255,198,39,.25)}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:end; margin-bottom:8px}
    .row.single{grid-template-columns: 1fr}
    .row.lang4{grid-template-columns: repeat(4, 1fr)}

    .btn{appearance:none; border:1px solid var(--card-border); background:linear-gradient(180deg,#fff,#f7f7f7); color:var(--text); padding:12px 16px; border-radius:14px; cursor:pointer; font-weight:700; letter-spacing:.2px;}
    .btn.primary{background:linear-gradient(90deg,var(--gold),#ffd970); color:#000; border:none}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .note{font-size:12px; color:#6B7280; margin-top:6px}

    .out{display:grid; gap:12px}
    .out .line{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border:1px dashed var(--card-border); border-radius:12px}

    .callout{border-left:4px solid var(--gold); padding:12px; background:linear-gradient(180deg, rgba(255,198,39,.14), rgba(255,198,39,.05)); border-radius:10px}

    .hero{ margin: 10px 0 14px; padding:16px; border-radius:16px; background:linear-gradient(180deg, rgba(16,185,129,.18), rgba(16,185,129,.06)); border:1px solid rgba(16,185,129,.35)}
    .hero h3{ margin:0 0 6px; font-size:18px; color:#064E3B }
    .hero p{ margin:0; color:#065F46 }
    .hero.warn{ background:linear-gradient(180deg, rgba(245,158,11,.18), rgba(245,158,11,.06)); border-color: rgba(245,158,11,.35) }
    .hero.warn h3{ color:#92400E }
    .hero.warn p{ color:#B45309 }
    .hero.bad{ background:linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.06)); border-color: rgba(239,68,68,.35) }
    .hero.bad h3{ color:#991B1B }
    .hero.bad p{ color:#B91C1C }

    .hidden{display:none!important}

    /* Confetti scoped to Results only so it can't overlay the inputs */
    #results-bd{ position: relative; overflow: hidden }
    #results-bd #confetti{ position:absolute; inset:0; pointer-events:none; z-index:2 }

    /* Ensure inputs remain clickable and above any effects */
    .qblock select, .qblock input { pointer-events: auto; position: relative; }
    #inputs-card { position: relative; z-index: 3; }
    aside.card { position: relative; z-index: 1; }

    /* Compact (embed) mode */
    body.compact .wrap{max-width:760px}
    body.compact header p{display:none}
    body.compact .grid-2{grid-template-columns: 1.2fr .8fr}

    /* Print styles */
    @media print{
      header{display:none}
      .toolbar{display:none}
      .qblock{background:#fff}
      .hero, .callout{background:#fff; border-color:#000}
      a{color:#000; text-decoration:underline}
      #confetti{display:none!important}
      body{color:#000}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ASU Core GPA Calculator</h1>
        <p>Enter grades by <strong>semester</strong> to estimate ASU core GPA and eligibility.</p>
      </div>
      <div class="ver">
        <span id="save-ind" class="note">v1.2</span>
      </div>
    </header>

    <div class="grid grid-2" id="app">
      <!-- Left: Inputs -->
      <section class="card" id="inputs-card">
        <div class="bd">

          <div class="qblock">
            <h3>About you</h3>
            <label for="grade-level">What grade are you in?</label>
            <select id="grade-level"><option value="">Select grade</option><option value="9">9th</option><option value="10">10th</option><option value="11">11th</option><option value="12">12th</option></select>
            <label for="top25" style="margin-top:8px">Are you in the top 25% of your class?</label>
            <select id="top25"><option value="no">No / Not sure</option><option value="yes">Yes</option></select>
          </div>

          <div class="qblock">
            <h3>Optional test scores</h3>
            <label for="testScoreToggle">Would you like to enter ACT/SAT scores?</label>
            <select id="testScoreToggle"><option value="no">No</option><option value="yes">Yes</option></select>
            <div id="testScoreSection" class="hidden" style="margin-top:8px">
              <fieldset style="border:none;padding:0;margin:0 0 10px 0">
                <legend class="subhead" style="margin:0 0 6px 0">ACT</legend>
                <label for="actComposite">ACT Composite (optional)</label>
                <input type="number" id="actComposite" min="1" max="36" placeholder="e.g., 22"/>
                <label for="actEnglish">ACT English (optional)</label>
                <input type="number" id="actEnglish" min="0" max="36" placeholder="e.g., 21"/>
                <label for="actMath">ACT Math (optional)</label>
                <input type="number" id="actMath" min="0" max="36" placeholder="e.g., 24"/>
              </fieldset>
              <fieldset style="border:none;padding:0;margin:0">
                <legend class="subhead" style="margin:0 0 6px 0">SAT</legend>
                <label for="satTotal">SAT Total (optional)</label>
                <input type="number" id="satTotal" min="400" max="1600" placeholder="e.g., 1120"/>
                <label for="satEnglish">SAT ERW (optional)</label>
                <input type="number" id="satEnglish" min="200" max="800" placeholder="e.g., 580"/>
                <label for="satMath">SAT Math (optional)</label>
                <input type="number" id="satMath" min="200" max="800" placeholder="e.g., 580"/>
              </fieldset>
            </div>
          </div>

          <div class="qblock" data-area="english">
            <h3>English (4 credits)</h3>
            <div class="subhead">Freshman English</div><div id="english-9-rows"></div>
            <div class="subhead">Sophomore English</div><div id="english-10-rows"></div>
            <div class="subhead">Junior English</div><div id="english-11-rows"></div>
            <div class="subhead">Senior English</div><div id="english-12-rows"></div>
          </div>

          <div class="qblock" data-area="math">
            <h3>Math (4 credits)</h3>
            <div class="subhead">Algebra I</div><div id="math-algebra1-rows"></div>
            <div class="subhead">Geometry</div><div id="math-geometry-rows"></div>
            <div class="subhead">Algebra II</div><div id="math-algebra2-rows"></div>
            <div class="subhead">Advanced Math</div><div id="math-advanced-rows"></div>
          </div>

          <div class="qblock" data-area="lab">
            <h3>Lab Science (3 credits)</h3>
            <div class="subhead">Biology</div><div id="lab-biology-rows"></div>
            <div class="subhead">Chemistry</div><div id="lab-chemistry-rows"></div>
            <div class="subhead">Physics or Earth Science</div><div id="lab-physics-rows"></div>
          </div>

          <div class="qblock" data-area="social">
            <h3>Social Studies (2 credits)</h3>
            <div class="subhead">American History</div><div id="social-history-rows"></div>
            <div class="subhead">Government</div><div id="social-government-rows"></div>
            <div class="subhead">Economics</div><div id="social-economics-rows"></div>
          </div>

          <div class="qblock" data-area="lang">
            <h3>Second Language (2 credits in the <em>same</em> language)</h3>
            <div id="lang-rows"></div>
          </div>

          <div class="qblock" data-area="arts">
            <h3>Fine Arts or Career & Technical Education (1 credit)</h3>
            <div id="arts-rows"></div>
          </div>

          <div class="toolbar">
            <button class="btn primary" id="calc">Calculate GPA</button>
            <button class="btn" id="print">Print / PDF</button>
          </div>
          <div class="note" id="save-note">Autosaves as you go. Your entries automatically restore on this device. Results remain blank until you click <em>Calculate GPA</em>.</div>
        </div>
      </section>

      <!-- Right: Results -->
      <aside class="card" aria-labelledby="r-h">
        <div class="hd"><h2 id="r-h">Results</h2><span id="status-pill" class="pill">Waitingâ€¦</span></div>
        <div class="bd" id="results-bd">
          <canvas id="confetti" class="hidden"></canvas>
          <div id="hero" class="hero hidden"></div>
          <div class="out" id="summary">
            <div class="line"><span>ABOR Core GPA</span><strong id="gpa">â€”</strong></div>
            <div class="line"><span>Credits counted</span><strong id="credits">â€”</strong></div>
          </div>
          <div id="messages" style="margin-top:12px"></div>
          <div class="callout" id="guidance" style="margin-top:14px; font-size:13px">Guidance is based on ABOR core requirements and unweighted grades. For official admission information, see the <a href="https://admission.asu.edu/apply/first-year/competency-requirements" target="_blank" rel="noopener">competency requirements</a> and the <a href="https://admission.asu.edu/requirements" target="_blank" rel="noopener">ASU admission requirements</a>.</div>
          <details id="explain" class="callout" style="margin-top:12px">
            <summary><strong>How this result was decided</strong></summary>
            <div id="explain-body" style="margin-top:8px; font-size:14px"></div>
          </details>
        </div>
      </aside>
    </div>
  </div>

  <script>
  (function(){
    const VERSION = '1.2.0';
    const LS_KEY = 'aborCalcV1';

    const gradeMap = {A:4, B:3, C:2, D:1, F:0};
    const creditPerSem = 0.5;
    const dom = {
      gradeLevel: document.getElementById('grade-level'),
      top25: document.getElementById('top25'),
      testToggle: document.getElementById('testScoreToggle'),
      testSection: document.getElementById('testScoreSection'),
      actComposite: document.getElementById('actComposite'),
      actEng: document.getElementById('actEnglish'),
      actMath: document.getElementById('actMath'),
      satTotal: document.getElementById('satTotal'),
      satEng: document.getElementById('satEnglish'),
      satMath: document.getElementById('satMath'),
      calc: document.getElementById('calc'),
      print: document.getElementById('print'),
      saveInd: document.getElementById('save-ind'),
      gpa: document.getElementById('gpa'),
      credits: document.getElementById('credits'),
      messages: document.getElementById('messages'),
      pill: document.getElementById('status-pill'),
      hero: document.getElementById('hero'),
      confetti: document.getElementById('confetti'),
      explainBody: document.getElementById('explain-body'),
      rows: {
        'english:9': document.getElementById('english-9-rows'),
        'english:10': document.getElementById('english-10-rows'),
        'english:11': document.getElementById('english-11-rows'),
        'english:12': document.getElementById('english-12-rows'),
        'math:algebra1': document.getElementById('math-algebra1-rows'),
        'math:geometry': document.getElementById('math-geometry-rows'),
        'math:algebra2': document.getElementById('math-algebra2-rows'),
        'math:advanced': document.getElementById('math-advanced-rows'),
        'lab:biology': document.getElementById('lab-biology-rows'),
        'lab:chemistry': document.getElementById('lab-chemistry-rows'),
        'lab:physics': document.getElementById('lab-physics-rows'),
        'social:history': document.getElementById('social-history-rows'),
        'social:government': document.getElementById('social-government-rows'),
        'social:economics': document.getElementById('social-economics-rows'),
        lang: document.getElementById('lang-rows'),
        arts: document.getElementById('arts-rows')
      }
    };

    function allSelects(){ return Array.from(document.querySelectorAll('.qblock select')); }

    dom.testToggle.addEventListener('change',()=>{
      dom.testSection.classList.toggle('hidden', dom.testToggle.value !== 'yes');
      saveState();
    });

    function semSelect(label){
      const s = document.createElement('select');
      s.innerHTML = `<option value="">${label}</option><option>A</option><option>B</option><option>C</option><option>D</option><option>F</option>`;
      s.addEventListener('change', saveState);
      return s;
    }
    function addFixedRow(key){
      const row = document.createElement('div'); row.className = 'row';
      const sem1 = semSelect('Sem 1'); const sem2 = semSelect('Sem 2');
      row.appendChild(sem1); row.appendChild(sem2);
      dom.rows[key].appendChild(row);
    }
    function addSingleRow(key){
      const row = document.createElement('div'); row.className = 'row single';
      const sem1 = semSelect('Sem 1');
      row.appendChild(sem1);
      dom.rows[key].appendChild(row);
    }
    // Second language stacked 1â€“4
    function addLangFourStacked(){
      const row = document.createElement('div'); row.className = 'row lang4';
      row.appendChild(semSelect('Sem 1'));
      row.appendChild(semSelect('Sem 2'));
      row.appendChild(semSelect('Sem 3'));
      row.appendChild(semSelect('Sem 4'));
      dom.rows.lang.appendChild(row);
    }

    function seed(){
      ['english:9','english:10','english:11','english:12'].forEach(k=>{ if(!dom.rows[k].children.length) addFixedRow(k); });
      ['math:algebra1','math:geometry','math:algebra2','math:advanced'].forEach(k=>{ if(!dom.rows[k].children.length) addFixedRow(k); });
      ['lab:biology','lab:chemistry','lab:physics'].forEach(k=>{ if(!dom.rows[k].children.length) addFixedRow(k); });
      if(!dom.rows['social:history'].children.length) addFixedRow('social:history');
      // Government & Economics are ONE semester each
      if(!dom.rows['social:government'].children.length) addSingleRow('social:government');
      if(!dom.rows['social:economics'].children.length) addSingleRow('social:economics');
      // second language stacked 1â€“4
      if(!dom.rows.lang.children.length) addLangFourStacked();
      if(!dom.rows.arts.children.length) addFixedRow('arts');
    }

    function setPill(text, kind){ dom.pill.textContent = text; dom.pill.className = 'pill ' + (kind||''); }
    function collectGrades(container){ return Array.from(container.querySelectorAll('select')).map(s=> s.value && gradeMap[s.value]).filter(v=> typeof v === 'number'); }
    function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
    function geq(a,b){ return (a - b) >= -1e-6; }

    function compute(){
      const parts = { english:{}, math:{}, lab:{}, social:{}, lang:{}, arts:{} };
      const groupKeys = {
        english:['english:9','english:10','english:11','english:12'],
        math:['math:algebra1','math:geometry','math:algebra2','math:advanced'],
        lab:['lab:biology','lab:chemistry','lab:physics'],
        social:['social:history','social:government','social:economics']
      };
      let totalSemesters = 0; let totalPoints = 0;

      const engGroups = {};
      groupKeys.english.forEach(k=>{ const vals = collectGrades(dom.rows[k]); totalSemesters += vals.length; totalPoints += sum(vals); const sub = k.split(':')[1]; engGroups[sub] = { semesters: vals.length, gpa: vals.length? (sum(vals)/vals.length):0 }; });
      const engSem = Object.values(engGroups).reduce((n,g)=>n+g.semesters,0);
      const engPts = Object.values(engGroups).reduce((n,g)=>n + (g.semesters? g.gpa*g.semesters:0),0);
      parts.english = { label:'English', semesters: engSem, gpa: engSem? (engPts/engSem):0, groups: engGroups };

      ['math','lab','social'].forEach(area=>{
        const groups = {}; groupKeys[area].forEach(k=>{ const vals = collectGrades(dom.rows[k]); totalSemesters += vals.length; totalPoints += sum(vals); const sub = k.split(':')[1]; groups[sub] = { semesters: vals.length, gpa: vals.length? (sum(vals)/vals.length):0 }; });
        const areaSem = Object.values(groups).reduce((n,g)=>n+g.semesters,0);
        const areaPts = Object.values(groups).reduce((n,g)=>n + (g.semesters? g.gpa*g.semesters:0),0);
        parts[area] = { label: area==='math'?'Math':area==='lab'?'Lab Science':'Social Studies', semesters: areaSem, gpa: areaSem? (areaPts/areaSem):0, groups };
      });

      const langVals = collectGrades(dom.rows.lang); totalSemesters += langVals.length; totalPoints += sum(langVals); parts.lang = { label:'Second Language', semesters:langVals.length, gpa: langVals.length? (sum(langVals)/langVals.length):0 };
      const artsVals = collectGrades(dom.rows.arts); totalSemesters += artsVals.length; totalPoints += sum(artsVals); parts.arts = { label:'Fine Arts/CTE', semesters:artsVals.length, gpa: artsVals.length? (sum(artsVals)/artsVals.length):0 };

      const totalCredits = totalSemesters * creditPerSem; const coreGPA = totalSemesters? (totalPoints/totalSemesters) : 0;
      return { parts, coreGPA, totalCredits };
    }

    function competency(parts){
      const need = { english:4, math:4, lab:3, social:2, lang:2, arts:1 };
      const missingCredits = {}; const flags = [];
      const gpaDeficiencyAreas = new Set();
      const missingAreas = new Set();
      Object.keys(need).forEach(k=>{
        const haveCredits = (parts[k].semesters||0) * creditPerSem;
        const miss = Math.max(0, need[k] - haveCredits);
        missingCredits[k] = miss;
        if(miss>0) missingAreas.add(k);
        const gpaBad = (parts[k].semesters>0 && parts[k].gpa < 2.0);
        if(gpaBad) gpaDeficiencyAreas.add(k);
      });
      const missingList = Object.entries(missingCredits)
        .filter(([,v])=> v>0)
        .map(([k,v])=> ({english:'English',math:'Math',lab:'Lab Science',social:'Social Studies',lang:'Second Language',arts:'Fine Arts/CTE'}[k] + ': ' + v.toFixed(1) + ' credit(s)'));
      const deficiencyAreas = new Set([...gpaDeficiencyAreas, ...missingAreas]);
      return { missingList, flags, deficiencyAreas, gpaDeficiencyAreas, missingAreas };
    }

    // small helper so we can unit-test the allowed-deficiency rule
    function allowedDefOk(considered){
      const mathDef = considered.has('math');
      const labDef = considered.has('lab');
      return (considered.size <= 2) && !(mathDef && labDef);
    }

    function renderSummary(parts){
      const summary = document.getElementById('summary');
      const old = summary.querySelector('[data-extra]');
      if(old) old.remove();
      const extra = document.createElement('div');
      extra.setAttribute('data-extra','1');
      extra.style.marginTop='10px';
      const h3 = document.createElement('h3');
      h3.textContent = 'Subject GPAs';
      h3.style.cssText = 'font-size:16px; color:var(--maroon); margin:6px 0';
      extra.appendChild(h3);
      function pillFor(n){ if(n==='â€”') return ''; return n>=3.0?'ok': n>=2.0?'warn':'bad'; }
      const labels = { english:'English', math:'Math', lab:'Lab Science', social:'Social Studies', lang:'Second Language', arts:'Fine Arts/CTE' };
      ['english','math','lab','social','lang','arts'].forEach(k=>{
        const g = parts[k].semesters? parts[k].gpa.toFixed(2) : 'â€”';
        const line = document.createElement('div');
        line.className='line';
        line.innerHTML = `<span>${labels[k]}</span><span class="pill ${pillFor(g==='â€”'?g:parseFloat(g))}">${g}</span>`;
        extra.appendChild(line);
      });
      summary.appendChild(extra);
    }

    function renderHero(kind, title, body){ dom.hero.className='hero ' + (kind||''); dom.hero.innerHTML = `<h3>${title}</h3><p>${body}</p>`; dom.hero.classList.remove('hidden'); }

    function launchConfetti(){
      const cvs = dom.confetti, ctx = cvs.getContext('2d');
      const DPR = window.devicePixelRatio || 1;
      const container = document.getElementById('results-bd');
      const rect = container.getBoundingClientRect();
      const W = cvs.width = Math.max(1, Math.floor(rect.width * DPR));
      const H = cvs.height = Math.max(1, Math.floor(rect.height * DPR));
      cvs.style.width = rect.width + 'px';
      cvs.style.height = rect.height + 'px';
      cvs.classList.remove('hidden');
      const colors=['#FFD166','#06D6A0','#118AB2','#8338EC','#FFC627']; const N=160; const parts=[];
      for(let i=0;i<N;i++){ parts.push({x:Math.random()*W,y:-20-Math.random()*H,r:4+Math.random()*6,a:Math.random()*Math.PI*2,v:2+Math.random()*3,w:(Math.random()<.5?1:-1)*(1+Math.random()),c:colors[(Math.random()*colors.length)|0]}); }
      let t0=null; function step(ts){ if(!t0) t0=ts; const dt=ts-t0; ctx.clearRect(0,0,W,H); parts.forEach(p=>{ p.y+=p.v*DPR; p.x+=Math.sin(p.y/25)*1.2*DPR; p.a+=0.1*p.w; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle=p.c; ctx.fillRect(-p.r/2*DPR,-p.r/2*DPR,p.r*DPR,p.r*DPR); ctx.restore(); }); if(dt<2600){ requestAnimationFrame(step);} else { ctx.clearRect(0,0,W,H); cvs.classList.add('hidden'); cvs.style.pointerEvents = 'none'; cvs.style.display = 'none'; cvs.width = 1; cvs.height = 1; } } requestAnimationFrame(step);
    }

    function renderExplain({coreGPA, gradeLevel, consideredDefs, allowedDeficiencies, top25Eligible, actComposite, satTotal, testEligibleSubject, missingList}){
      const list = [];
      list.push(`<div><strong>Grade:</strong> ${gradeLevel||'â€”'}</div>`);
      list.push(`<div><strong>Core GPA:</strong> ${coreGPA.toFixed(2)}</div>`);
      const defs = Array.from(consideredDefs);
      const defNames = defs.map(x=>({math:'Math',lab:'Lab Science',english:'English',social:'Social Studies',lang:'Second Language',arts:'Fine Arts/CTE'}[x]||x)).join(', ');
      list.push(`<div><strong>Deficiency areas considered:</strong> ${defs.length? defNames : 'None'}</div>`);
      list.push(`<div><strong>Allowed-deficiency rule:</strong> ${allowedDeficiencies? 'Within limit (â‰¤2 and not both Math & Lab)': 'Not within limit'}</div>`);
      const reasons = [];
      if(top25Eligible) reasons.push('Top 25% class rank');
      if(actComposite>=22) reasons.push('ACT composite â‰¥ 22');
      if(satTotal>=1120) reasons.push('SAT total â‰¥ 1120');
      if(testEligibleSubject) reasons.push('English & Math test thresholds met (ACT/SAT)');
      reasons.push('3.0+ core GPA (if within allowed-deficiency rule)');
      list.push(`<div><strong>Assured-admission checks:</strong> ${reasons.join(' â€¢ ')}</div>`);
      if(missingList?.length){ list.push(`<div><strong>Items to finish:</strong> ${missingList.join('; ')}</div>`); }
      dom.explainBody.innerHTML = list.join('');
    }

    function renderMessages({coreGPA, parts, missingList, flags, deficiencyAreas, gpaDeficiencyAreas, missingAreas}){
      const msgs=[]; const gradeLevel=parseInt(dom.gradeLevel.value||'0',10); const isSenior=(gradeLevel===12);
      // For underclassmen, evaluate deficiencies using ONLY GPA-based deficiencies (ignore credit shortfalls).
      const consideredDefs = isSenior ? new Set([...gpaDeficiencyAreas, ...missingAreas]) : new Set([...gpaDeficiencyAreas]);
      const defCount = consideredDefs.size; const mathDef = consideredDefs.has('math'); const labDef = consideredDefs.has('lab');
      const allowedDeficiencies = allowedDefOk(consideredDefs);
      const hasAllowedDef = allowedDeficiencies && defCount>0;

      // Subject-score competency path: ACT Eng >=21 & ACT Math >=24 OR SAT ERW >=580 & SAT Math >=580
      const actEng = parseInt(dom.actEng?.value||''); const actMath = parseInt(dom.actMath?.value||'');
      const satEng = parseInt(dom.satEng?.value||''); const satMath = parseInt(dom.satMath?.value||'');
      const testEligibleSubject = (actEng>=21 && actMath>=24) || (satEng>=580 && satMath>=580);

      // Assured admission â€” any ONE qualifies (GPA uses allowed-deficiency rule)
      const top25Eligible = (dom.top25?.value === 'yes');
      const actComposite = parseInt(dom.actComposite?.value||'');
      const satTotal = parseInt(dom.satTotal?.value||'');
      const assuredAny = top25Eligible || (actComposite>=22) || (satTotal>=1120) || (geq(coreGPA,3.0) && allowedDeficiencies);

      const eligible = assuredAny || testEligibleSubject;

      if(eligible){
        setPill('Admissible','ok');
        let reason = '';
        if(top25Eligible) reason = 'top 25% class rank';
        else if(actComposite>=22) reason = 'ACT composite â‰¥ 22';
        else if(satTotal>=1120) reason = 'SAT total â‰¥ 1120';
        else if(testEligibleSubject) reason = 'English & Math test scores meet thresholds';
        else reason = '3.0+ core GPA';
        const heroTitle = hasAllowedDef ? 'ðŸŽ‰ Youâ€™re admissible â€” with an allowed deficiency!' : 'ðŸŽ‰ Youâ€™re admissible!';
        const heroBody = `You qualify via ${reason}. Estimated core GPA: ${coreGPA.toFixed(2)}.`;
        renderHero('ok', heroTitle, heroBody);
        launchConfetti();

        if(hasAllowedDef){
          const link = '<a href="https://admission.asu.edu/apply/first-year/competency-requirements" target="_blank" rel="noopener">competency deficiency policy</a>';
          const expl = 'ASU may admit students with a deficiency in no more than two competency areas (but not both Math and Lab Science).';
          const title = isSenior ? 'Admissible with an allowed deficiency' : 'On track within the allowed-deficiency policy';
          msgs.push({ title, kind:'ok', body: `${expl} See the ${link}.` });
        }

        if(deficiencyAreas.size>0 || flags.length){
          const items=[missingList.length?('Still needed for competencies: '+missingList.join('; ')):'', flags.join(' â€¢ ')].filter(Boolean).join(' â€¢ ');
          if(items){ msgs.push({ title: isSenior ? 'Items to address for competency' : 'Keep an eye on', kind:'warn', body: items }); }
        }
      } else {
        // Not eligible: supportive guidance + explicit alternative assured-admission paths
        const altList = [
          'Top 25% of graduating class',
          '3.0+ core GPA (with up to two allowed deficiencies, not both in Math & Lab Science)',
          'ACT composite â‰¥ 22',
          'SAT total â‰¥ 1120',
          'English & Math test scores: ACT Eng â‰¥ 21 & Math â‰¥ 24, or SAT ERW â‰¥ 580 & Math â‰¥ 580'
        ].join(' â€¢ ');

        // Explicit message when BOTH Math and Lab Science are deficient (policy does not allow this combo)
        if (mathDef && labDef) {
          const link = '<a href="https://admission.asu.edu/apply/first-year/competency-requirements" target="_blank" rel="noopener">competency deficiency policy</a>';
          msgs.push({
            title: 'Math & Lab Science both deficient',
            kind: 'bad',
            body: `Admission with deficiencies does not allow both Math and Lab Science to be deficient at the same time. Improve one of these areas or qualify via another assured path. See the ${link}.`
          });
        }

        if(!isSenior){
          // Underclassmen: celebratory "on track" if 3.0+ and allowed under underclass rule
          if(geq(coreGPA,3.0) && allowedDeficiencies){
            setPill('On track','ok');
            renderHero('ok','ðŸŽ‰ Youâ€™re on track for assured admission!','Great job keeping your core GPA at 3.0+. Finish competencies over time and youâ€™ll be set.');
            launchConfetti();
          } else if(coreGPA>=2.5){
            setPill('Keep building','warn');
            renderHero('warn','Keep building','Aim for a 3.0+ core GPA and finish competencies. Youâ€™re getting there!');
          } else {
            setPill('Needs improvement','bad');
            renderHero('bad','Letâ€™s raise that GPA','Focus on improving grades in core classes; every semester matters.');
          }
          if(missingList.length||flags.length){ const items=[missingList.length?('Working toward: '+missingList.join('; ')):'', flags.join(' â€¢ ')].filter(Boolean).join(' â€¢ '); if(items) msgs.push({ title:'Progress to competencies', kind:'warn', body: items }); }
          msgs.push({ title:'Other ways to qualify', kind:'warn', body: altList });
        } else {
          if(deficiencyAreas.size>0 || flags.length){ setPill('Deficiency','bad'); renderHero('bad','Competency deficiency','Complete the missing items below to qualify.'); }
          else if(coreGPA>=2.5){ setPill('Possible â€” other paths','warn'); renderHero('warn','Possible via other pathways','You might still qualify through rank or tests. See options below.'); }
          else { setPill('Below threshold','bad'); renderHero('bad','Below the usual threshold','Improve grades or consider alternate pathways.'); }
          msgs.push({ title:'Alternative assured-admission paths', kind:'warn', body: altList });
        }
      }

      if(coreGPA>=3.40 && (eligible || (!isSenior && geq(coreGPA,3.40)))){ msgs.push({ title:'Barrett potential', kind:'ok', body:`With a core GPA of ${coreGPA.toFixed(2)}, consider Barrett (holistic review).` }); }

      dom.messages.innerHTML=''; msgs.forEach(m=>{ const div=document.createElement('div'); div.className='callout'; div.style.borderLeftColor = m.kind==='ok'? 'var(--ok)' : m.kind==='warn'? 'var(--warn)' : m.kind==='bad'? 'var(--bad)' : 'var(--gold)'; div.innerHTML = `<strong>${m.title}</strong><div style="margin-top:6px">${m.body}</div>`; dom.messages.appendChild(div); });

      renderExplain({ coreGPA, gradeLevel, consideredDefs, allowedDeficiencies, top25Eligible:(dom.top25?.value==='yes'), actComposite:parseInt(dom.actComposite?.value||''), satTotal:parseInt(dom.satTotal?.value||''), testEligibleSubject, missingList });
    }

    function calculate(){
      const { parts, coreGPA, totalCredits } = compute();
      const { missingList, flags, deficiencyAreas, gpaDeficiencyAreas, missingAreas } = competency(parts);
      document.getElementById('gpa').textContent = totalCredits? coreGPA.toFixed(2) : 'â€”';
      document.getElementById('credits').textContent = totalCredits.toFixed(1);
      renderSummary(parts);
      renderMessages({coreGPA, parts, missingList, flags, deficiencyAreas, gpaDeficiencyAreas, missingAreas});
      document.getElementById('r-h').scrollIntoView({behavior:'smooth'});
      saveState();
    }

    // --- Local save/restore ---
    function flashSaved(msg){ dom.saveInd.textContent = msg||'Saved âœ”'; setTimeout(()=>{ dom.saveInd.textContent = 'v1.2'; }, 1600); }

    function saveState(){
      try{
        const state = {
          v: VERSION,
          grade: dom.gradeLevel.value,
          top25: dom.top25.value,
          testToggle: dom.testToggle.value,
          actComposite: dom.actComposite.value,
          actEng: dom.actEng.value,
          actMath: dom.actMath.value,
          satTotal: dom.satTotal.value,
          satEng: dom.satEng.value,
          satMath: dom.satMath.value,
          selects: allSelects().map(s=> s.value)
        };
        localStorage.setItem(LS_KEY, JSON.stringify(state));
        flashSaved();
      }catch(e){ /* ignore quota */ }
    }

    function restoreState(){
      try{
        const raw = localStorage.getItem(LS_KEY); if(!raw) return false; const s = JSON.parse(raw);
        dom.gradeLevel.value = s.grade||''; dom.top25.value = s.top25||'no'; dom.testToggle.value = s.testToggle||'no'; dom.testSection.classList.toggle('hidden', dom.testToggle.value !== 'yes');
        ['actComposite','actEng','actMath','satTotal','satEng','satMath'].forEach(id=>{ if(dom[id]) dom[id].value = s[id]||''; });
        const selects = allSelects();
        (s.selects||[]).forEach((val,i)=>{ if(selects[i]) selects[i].value = val||''; });
        flashSaved('Restored âœ”');
        return true;
      }catch(e){ return false; }
    }

    // --- Print ---
    function doPrint(){ window.print(); }

    // Bind
    function bindInputs(){
      ['change','input'].forEach(evt=>{
        ['gradeLevel','top25','actComposite','actEng','actMath','satTotal','satEng','satMath'].forEach(k=>{
          if(dom[k]) dom[k].addEventListener(evt, saveState);
        });
      });
    }

    // Seed fixed inputs for each section
    function initRows(){
      seed();
    }

    function blankOutputs(){
      dom.gpa.textContent = 'â€”';
      dom.credits.textContent = 'â€”';
      dom.messages.innerHTML = '';
      dom.hero.classList.add('hidden');
      setPill('Waitingâ€¦','');
      const extra = document.querySelector('#summary [data-extra]');
      if(extra) extra.remove();
    }

    function init(){
      initRows();
      bindInputs();
      dom.calc.addEventListener('click', calculate);
      dom.print.addEventListener('click', doPrint);

      // auto-restore if available, but keep UI blank until user calculates
      restoreState();
      blankOutputs();

      // embed param
      const params = new URLSearchParams(location.search);
      if(params.get('embed')==='1'){ document.body.classList.add('compact'); }
    }

    // ---------- Developer self-tests (console) ----------
    function selfTests(){
      try{
        console.assert((3.0 - 3.0) >= -1e-6, 'float guard');
        (function(){ const considered = new Set(['math','lab']); console.assert(!allowedDefOk(considered), 'both math & lab should not be allowed together'); })();
        console.assert(22>=22, 'ACT 22 path present');
        console.assert(1120>=1120, 'SAT 1120 path present');
      }catch(e){ /* no-op */ }
    }

    init();
    selfTests();
  })();
  </script>
</body>
</html>
